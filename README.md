##  Next.js + NestJS + Bun + Postgres

A small monorepo demonstrating a tasks CRUD app:

- **Web (test-app)**: Next.js 15, React 19, TanStack Query, Tailwind v4, Motion
- **API (api)**: NestJS (Fastify), Drizzle ORM, PostgreSQL, Swagger
- **Tooling**: Bun 1.x, Biome, Docker Compose

---

### Quick start with Docker (recommended)

Prerequisites: Docker, Docker Compose.

1) Build and start all services:

```bash
docker-compose up -d --build
```

2) Open the apps:

- Web UI: [http://localhost:3000](http://localhost:3000)
- API Docs (Swagger): [http://localhost:4000/docs](http://localhost:4000/docs)

Notes:

- The API container runs DB migrations automatically on start, so the `tasks` table is created.
- The web container uses `NEXT_PUBLIC_API_URL=http://api:4000` (set in `docker-compose.yml`).

Stop everything:

```bash
docker-compose down
```

---

### Local development (Bun)

Prerequisites: Bun ≥ 1.1.0 (project uses `bun@1.1.28`), PostgreSQL (local or via Docker).

1) Install deps once at repo root:

```bash
bun install
```

2) Start a Postgres DB (option A: Docker):

```bash
docker-compose up -d db
```

3) Configure envs:

- API (`api/.env`):

```bash
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/tasks
```

- Web (`test-app/.env.local`):

```bash
# Optional for local dev; defaults to http://localhost:4000 when NODE_ENV=development
NEXT_PUBLIC_API_URL=http://localhost:4000
```

4) Apply DB migrations (creates `tasks` table):

```bash
bun run db:migrate
```

5) Run the apps:

```bash
# Terminal 1
bun run dev:api

# Terminal 2
bun run dev:web
```

Open:

- Web UI: [http://localhost:3000](http://localhost:3000)
- API Docs: [http://localhost:4000/docs](http://localhost:4000/docs)

---

### Monorepo scripts (root)

- `bun run dev:web` — start Web in dev
- `bun run dev:api` — start API in dev
- `bun run build:web` — build Web
- `bun run build:api` — build API
- `bun run start:web` — start Web in prod mode
- `bun run start:api` — start API in prod mode
- `bun run db:generate` — generate Drizzle migrations
- `bun run db:migrate` — apply DB migrations
- `bun run db:studio` — open Drizzle Studio

Web package (test-app): `dev`, `build`, `start`, `lint` (Biome), `format` (Biome)

API package (api): `dev`, `build`, `start`, `db:generate`, `db:migrate`, `db:studio`

---

### Environment variables

- **API** (`api/.env`)
  - `DATABASE_URL` (required): PostgreSQL connection string

- **Web** (`test-app/.env.local`)
  - `NEXT_PUBLIC_API_URL` (optional in dev): base URL of the API
    - In development, if unset, the web app falls back to `http://localhost:4000`.

---

### Architecture & folders

- `test-app/` — Next.js 15 app (React 19). Key bits:
  - `src/lib/api/` — API client (fetch wrappers)
  - `src/lib/queries/` — TanStack Query hooks
  - `src/components/` — UI components 


- `api/` — NestJS app (Fastify) with Drizzle ORM
  - `src/modules/tasks/` — CRUD routes and service
  - `src/db/schema.ts` — Drizzle schema (`tasks` table)
  - `src/db/migrate.ts` — migration runner
  - `drizzle/` — SQL migrations (generated by Drizzle Kit)

- `docker-compose.yml` — Postgres, API, Web services

---

### API overview

Base URL in local dev:

- Direct: `http://localhost:4000`
- In Docker: `http://api:4000` (container-to-container)

Endpoints (see Swagger for full details):

- `GET /tasks` — list tasks
  - Query params: `status` (comma list), `priority` (comma list), `q` (search), `sort` (e.g. `created_at.desc`)
- `GET /tasks/:id` — task by id
- `POST /tasks` — create task
- `PUT /tasks/:id` — update task
- `DELETE /tasks/:id` — delete task
- `GET /tasks/stats` — counts by status and priority

Example (create task):

```bash
curl -X POST http://localhost:4000/tasks \
  -H 'Content-Type: application/json' \
  -d '{
    "title": "Design landing",
    "description": "Hero & pricing",
    "status": "pending",
    "priority": "high"
  }'
```

---

### Frontend overview

- Data fetching and caching with TanStack Query
- Filtering by `status`/`priority` (server), free-text search `q` (client-side filter to avoid refetch flicker)

---

### Docker images

- **API image**
  - Builds with Bun
  - Copies compiled `dist` and `drizzle` migrations
  - On container start: runs `bun dist/db/migrate.js` then `bun start`

- **Web image**
  - Builds with `next build` 
  - Starts with `next start`

---

### Troubleshooting

- **relation "tasks" does not exist**
  - Migrations were not applied. Run: `bun run db:migrate` (local) or rebuild/restart API container.

- **Frontend calls return 404**
  - Ensure `NEXT_PUBLIC_API_URL` points to the API. In dev it defaults to `http://localhost:4000`.

- **Port already in use**
  - Change or free ports 3000 (web) and 4000 (api), or stop conflicting processes.

---







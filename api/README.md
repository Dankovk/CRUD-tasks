## Tasks API — NestJS + Fastify + Drizzle ORM + PostgreSQL

A small, production-leaning REST API for managing tasks. Built with NestJS (Fastify), Drizzle ORM (PostgreSQL), Zod validation, Swagger docs, and Bun as the runtime/package manager.

---

### Features

- CRUD endpoints for tasks with validation (Zod)
- Filtering by status/priority, full-text substring search on title (`ILIKE`)
- Aggregated statistics endpoint
- SQL-first approach with Drizzle schema and migrations
- Swagger docs at `/docs`
- Dockerized; runs DB migrations automatically on container start

---

### Quick start (Docker)

At the repository root:

```bash
docker-compose up -d --build
```

Then open:

- API: http://localhost:4000
- Swagger: http://localhost:4000/docs

Notes:

- The API service uses `DATABASE_URL=postgresql://postgres:postgres@db:5432/tasks` (from `docker-compose.yml`).
- On container start, migrations are applied automatically, then the server starts.

Stop services:

```bash
docker-compose down
```

---

### Local development (Bun)

Prerequisites: Bun ≥ 1.1.0, PostgreSQL.

1) Install dependencies (from repo root or `api/`):

```bash
bun install
```

2) Configure environment (`api/.env`):

```bash
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/tasks
PORT=4000
```

3) Apply migrations:

```bash
bun run db:migrate
```

4) Start the API in watch mode:

```bash
bun run dev
```

Build and run in production mode:

```bash
bun run build
bun run start
```

Open Swagger: http://localhost:4000/docs

---

### Scripts

- `bun run dev` — start Nest in watch mode on `PORT` (default 4000)
- `bun run build` — compile to `dist/`
- `bun run start` — run `dist/main.js` with Bun
- `bun run db:generate` — generate SQL migrations from the Drizzle schema
- `bun run db:migrate` — apply migrations from `drizzle/`
- `bun run db:studio` — open Drizzle Studio

---

### Environment variables

- **DATABASE_URL** (required): PostgreSQL connection string
- **PORT** (optional): API port (default `4000`)

Example: `postgresql://USER:PASS@HOST:PORT/DBNAME`

---

### Database & migrations

- Schema: `src/db/schema.ts`
- Migrations: `drizzle/` (generated by Drizzle Kit)
- Migration runner: `src/db/migrate.ts`

Indexes created:

- Single-column: `status`, `priority`, `due_date`
- Composite (filter + sort): `(status, created_at)`, `(priority, created_at)`

---

### API endpoints

Base URL: `http://localhost:4000` (or `${PORT}`)

- `GET /tasks`
  - Query params:
    - `status`: comma-separated list (`pending,in_progress,completed`)
    - `priority`: comma-separated list (`low,medium,high`)
    - `q`: substring search in title
    - `sort`: one of `created_at.asc|desc`, `priority.asc|desc`, `due_date.asc|desc`

- `GET /tasks/:id`

- `POST /tasks`
  - Body:
    - `title` (string, required, max 100)
    - `description` (string | null, max 500)
    - `status` (enum: `pending|in_progress|completed`)
    - `priority` (enum: `low|medium|high`)
    - `dueDate` (ISO string | null, must not be in the past)

- `PUT /tasks/:id`
  - Body: same fields as POST, all optional

- `DELETE /tasks/:id`

- `GET /tasks/stats`
  - Response: totals and grouped counts by status and priority

Example (create task):

```bash
curl -X POST http://localhost:4000/tasks \
  -H 'Content-Type: application/json' \
  -d '{
    "title": "Design landing",
    "description": "Hero & pricing",
    "status": "pending",
    "priority": "high"
  }'
```

Swagger docs: http://localhost:4000/docs

---

### Implementation details

- Framework: NestJS with Fastify adapter (`src/main.ts`)
- CORS: enabled for all origins (adjust for production)
- Validation: Zod schemas in `tasks.controller.ts`
- ORM: Drizzle with `node-postgres`
- DB client: `src/db/client.ts` (uses `DATABASE_URL`)
- Module: `src/modules/tasks/` (controller + service + DTOs)

Query optimizations:

- Multi-select filters for `status` and `priority` use SQL `IN` via Drizzle `inArray(...)`
- Aggregations (`/tasks/stats`) use `GROUP BY` on the DB rather than multiple point queries
- Composite indexes `(status, created_at)` and `(priority, created_at)` help common filter+sort paths

---

### Docker image (API)

Multi-stage build (see `Dockerfile`):

- Install deps → build → runtime image with `dist/` + `drizzle/`
- Entrypoint runs migrations, then starts the server:

```bash
sh -c "bun dist/db/migrate.js && bun start"
```

---

### Troubleshooting

- "relation \"tasks\" does not exist"
  - Migrations were not applied. Run `bun run db:migrate` locally, or rebuild/restart the API container.

- Database connection errors
  - Check `DATABASE_URL` and that Postgres is reachable.

- 400 validation errors
  - See details in the response body; Zod provides messages for invalid fields.

---
